--use TestDb
-- for dropping tables
alter table dbo.Orders drop constraint if exists FK_Orders_Customers, FK_Orders_Products
drop table if exists dbo.Customers, dbo.Orders, dbo.Products

-- creating tables
create table dbo.Customers (
ID int not null,
FirstName nchar(20) null,
LastName nchar(20) null,
CardNumber char(16) null,
constraint PK_Customers primary key clustered (ID asc)
)
create table dbo.Products (
ID int not null,
Name nchar(20),
Price money,
constraint PK_Products primary key clustered (ID asc)
)
create table dbo.Orders (
ID int not null,
ProductID int not null,
CustomerID int not null,
constraint PK_Orders primary key clustered (ID asc),
constraint FK_Orders_Customers foreign key(CustomerID) references dbo.Customers(ID),
constraint FK_Orders_Products foreign key(ProductID) references dbo.Products(ID)
)

-- inserting some entries to each table
insert into dbo.Customers (ID, FirstName, LastName, CardNumber) values
(1, 'Clark', 'Kent', '3892765810771328'),
(2, 'Tony', 'Stark', '5321754397810541'),
(3, 'Bruce', 'Lee', '6016438932985413')
insert into dbo.Products (ID, Name, Price) values
(1, 'Laptop', $300),
(2, 'Blender', $150),
(3, 'Plasma TV', $500)
insert into dbo.Orders (ID, ProductID, CustomerID) values
(1, 1, 1),
(2, 3, 2),
(3, 2, 3)

insert into dbo.Products (ID, Name, Price) values (4, 'IPhone', $200)

insert into dbo.Customers (ID, FirstName, LastName, CardNumber) values (4, 'Tina', 'Smith', '1234567890098765')

insert into dbo.Orders (ID, ProductID, CustomerID) values (4, 4, 4)

-- all orders by Tina Smith
select FirstName, LastName, Name as ProductName
from dbo.Customers as c inner join dbo.Orders as o on c.ID = o.CustomerID
inner join dbo.Products as p on o.ProductID = p.ID
where FirstName = 'Tina' and LastName = 'Smith'

-- inserting some additional iphone orders to verify if the query below worked
insert into dbo.Orders (ID, ProductID, CustomerID) values (5, 4, 1), (6, 4, 2)

-- all revenue generated by sales of iphone
select Name, ProductID, Price, count(ProductID) as QtySold, Price * count(ProductID) as Revenue
from dbo.Orders as o inner join dbo.Products as p on o.ProductID = p.ID
where Name = 'IPhone'
group by Name, ProductID, Price

-- update the price of iphone
update dbo.Products set Price = $250 where Name = 'IPhone'